var Bt=Object.create;var tt=Object.defineProperty;var Dt=Object.getOwnPropertyDescriptor;var jt=Object.getOwnPropertyNames;var Ut=Object.getPrototypeOf,Ht=Object.prototype.hasOwnProperty;var Wt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Vt=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of jt(t))!Ht.call(e,o)&&o!==n&&tt(e,o,{get:()=>t[o],enumerable:!(r=Dt(t,o))||r.enumerable});return e};var qt=(e,t,n)=>(n=e!=null?Bt(Ut(e)):{},Vt(t||!e||!e.__esModule?tt(n,"default",{value:e,enumerable:!0}):n,e));var Tt=Wt((Ln,J)=>{"use strict";var I=typeof Reflect=="object"?Reflect:null,xt=I&&typeof I.apply=="function"?I.apply:function(t,n,r){return Function.prototype.apply.call(t,n,r)},D;I&&typeof I.ownKeys=="function"?D=I.ownKeys:Object.getOwnPropertySymbols?D=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:D=function(t){return Object.getOwnPropertyNames(t)};function Xt(e){console&&console.warn&&console.warn(e)}var yt=Number.isNaN||function(t){return t!==t};function l(){l.init.call(this)}J.exports=l;J.exports.once=re;l.EventEmitter=l;l.prototype._events=void 0;l.prototype._eventsCount=0;l.prototype._maxListeners=void 0;var At=10;function j(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return At},set:function(e){if(typeof e!="number"||e<0||yt(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");At=e}});l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};l.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||yt(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function wt(e){return e._maxListeners===void 0?l.defaultMaxListeners:e._maxListeners}l.prototype.getMaxListeners=function(){return wt(this)};l.prototype.emit=function(t){for(var n=[],r=1;r<arguments.length;r++)n.push(arguments[r]);var o=t==="error",i=this._events;if(i!==void 0)o=o&&i.error===void 0;else if(!o)return!1;if(o){var a;if(n.length>0&&(a=n[0]),a instanceof Error)throw a;var u=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw u.context=a,u}var y=i[t];if(y===void 0)return!1;if(typeof y=="function")xt(y,this,n);else for(var X=y.length,Rt=bt(y,X),r=0;r<X;++r)xt(Rt[r],this,n);return!0};function Et(e,t,n,r){var o,i,a;if(j(n),i=e._events,i===void 0?(i=e._events=Object.create(null),e._eventsCount=0):(i.newListener!==void 0&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),a=i[t]),a===void 0)a=i[t]=n,++e._eventsCount;else if(typeof a=="function"?a=i[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),o=wt(e),o>0&&a.length>o&&!a.warned){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=a.length,Xt(u)}return e}l.prototype.addListener=function(t,n){return Et(this,t,n,!1)};l.prototype.on=l.prototype.addListener;l.prototype.prependListener=function(t,n){return Et(this,t,n,!0)};function te(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ft(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=te.bind(r);return o.listener=n,r.wrapFn=o,o}l.prototype.once=function(t,n){return j(n),this.on(t,Ft(this,t,n)),this};l.prototype.prependOnceListener=function(t,n){return j(n),this.prependListener(t,Ft(this,t,n)),this};l.prototype.removeListener=function(t,n){var r,o,i,a,u;if(j(n),o=this._events,o===void 0)return this;if(r=o[t],r===void 0)return this;if(r===n||r.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete o[t],o.removeListener&&this.emit("removeListener",t,r.listener||n));else if(typeof r!="function"){for(i=-1,a=r.length-1;a>=0;a--)if(r[a]===n||r[a].listener===n){u=r[a].listener,i=a;break}if(i<0)return this;i===0?r.shift():ee(r,i),r.length===1&&(o[t]=r[0]),o.removeListener!==void 0&&this.emit("removeListener",t,u||n)}return this};l.prototype.off=l.prototype.removeListener;l.prototype.removeAllListeners=function(t){var n,r,o;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[t]),this;if(arguments.length===0){var i=Object.keys(r),a;for(o=0;o<i.length;++o)a=i[o],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=r[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(o=n.length-1;o>=0;o--)this.removeListener(t,n[o]);return this};function St(e,t,n){var r=e._events;if(r===void 0)return[];var o=r[t];return o===void 0?[]:typeof o=="function"?n?[o.listener||o]:[o]:n?ne(o):bt(o,o.length)}l.prototype.listeners=function(t){return St(this,t,!0)};l.prototype.rawListeners=function(t){return St(this,t,!1)};l.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):It.call(e,t)};l.prototype.listenerCount=It;function It(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?D(this._events):[]};function bt(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function ee(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function ne(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function re(e,t){return new Promise(function(n,r){function o(a){e.removeListener(t,i),r(a)}function i(){typeof e.removeListener=="function"&&e.removeListener("error",o),n([].slice.call(arguments))}Lt(e,t,i,{once:!0}),t!=="error"&&oe(e,o,{once:!0})})}function oe(e,t,n){typeof e.on=="function"&&Lt(e,"error",t,n)}function Lt(e,t,n,r){if(typeof e.on=="function")r.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener=="function")e.addEventListener(t,function o(i){r.once&&e.removeEventListener(t,o),n(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}});function c(e){if(e instanceof Actor)return e;if(e instanceof Token)return e.actor;if(typeof e=="string"){let t=game.actors?.get(e);if(t||(t=game.actors?.getName(e),t))return t}}function N(e){if(e instanceof Playlist)return e;if(typeof e=="string"){let t=game.playlists?.get(e);if(t||(t=game.playlists?.getName(e),t))return t}}function W(e,t){if(e instanceof PlaylistSound)return e;let n=N(t);if(n&&typeof e=="string"){let r=n.sounds.get(e);if(r instanceof PlaylistSound||(r=n.sounds.getName(e),r instanceof PlaylistSound))return r}}async function m(e){return new Promise(t=>{setTimeout(t,e)})}function M(e,t){theatre.lastTyping=Date.now(),theatre.setUserTyping(game.user?.id,theatre.speakingAs),theatre._sendTypingEvent();let n=Gt(e,t);ChatMessage.create(n)}function Gt(e,t){return{content:t,style:2,author:game.user?.id,_id:foundry.utils.randomID(),type:"base",system:{},timestamp:Date.now(),flavor:"",speaker:{scene:null,actor:null,token:null,alias:e},whisper:[],blind:!1,rolls:[],sound:null,emote:!1,flags:{theatre:{theatreMessage:!0}},_stats:{compendiumSource:null,duplicateSource:null,coreVersion:game.release?.version,systemId:game.system?.id,systemVersion:game.system?.version,createdTime:Date.now(),modifiedTime:Date.now(),lastModifiedBy:game.user?.id}}}function V(e){if(!e||typeof e!="string")return!1;switch(e.substring(0,1)==="#"&&(e=e.substring(1)),e.length){case 3:return/^[0-9A-F]{3}$/i.test(e);case 6:return/^[0-9A-F]{6}$/i.test(e);case 8:return/^[0-9A-F]{8}$/i.test(e);default:return!1}}function et(e){try{return!!new URL(e,location.origin)}catch(t){if(!(t instanceof TypeError))throw t;return!1}}var f=class extends Error{constructor(t,n){t?super(game.i18n?.format(`THEATREAUTOMATION.ERRORS.${t}`,n)):super()}};var d=class extends f{constructor(){super("ACTORNOTACTIVE")}};var P=class extends f{constructor(){super("ACTORNOTSTAGED")}};var s=class extends f{constructor(){super("INVALIDACTOR")}};var C=class extends f{constructor(t){super("INVALIDFLYIN",{flyin:t})}};var b=class extends f{constructor(t){super("INVALIDCOLOR",{color:t})}};var w=class extends f{constructor(t){super("INVALIDFONT",{font:t})}};var E=class extends f{constructor(t){super("INVALIDSIZE",{size:t})}};var _=class extends f{constructor(t){super("INVALIDSTANDING",{standing:t})}};function v(e){let t=c(e);if(!(t instanceof Actor))throw new s;return!!theatre.getNavItemById(`theatre-${t.id}`)}function F(e){let t=c(e);if(!(t instanceof Actor))throw new s;v(t)||Theatre.addToNavBar(t)}function nt(e){let t=c(e);if(!(t instanceof Actor))throw new s;v(t)&&theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${t.id}`),button:2,ctrlKey:!0})}function x(e){let t=c(e);if(!(t instanceof Actor))throw new s;return v(t)||F(t),theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${t.id}`),button:2}),m(1500)}function L(e,t){let n=c(e);if(!(n instanceof Actor))throw new s;return theatre.removeInsertById(`theatre-${n.id}`,!1),t&&theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${n.id}`),button:2,ctrlKey:!0}),m(1500)}function g(e){let t=c(e);if(!(t instanceof Actor))throw new s;let n=theatre.getNavItemById(`theatre-${t.id}`);return n?n.classList.contains("theatre-control-nav-bar-item-active"):!1}function p(){if(theatre.speakingAs){let[,e]=theatre.speakingAs.split("-");return c(e)??null}else return null}function h(){return $(".theatre-control-nav-bar img.theatre-control-nav-bar-item-active").map(function(){return this.getAttribute("imgid")}).toArray().map(t=>{let[,n]=t.split("-");return game.actors.get(n)}).filter(t=>!!t)}function ot(e,t){let n=c(e);if(!(n instanceof Actor))throw new s;return Yt(n,t)}async function Yt(e,t){g(e)||await x(e),theatre.setUserEmote(game.user?.id,`theatre-${e.id}`,"emote",t,!1)}function it(e){let t=c(e);if(!(t instanceof Actor))throw new s;theatre.setUserEmote(game.user?.id,`theatre-${t.id}`,"emote","",!1)}function A(){return $(".theatre-control-btn .theatre-icon-narrator").parent().hasClass("theatre-control-nav-bar-item-speakingas")}async function q(){theatre.toggleNarratorBar(!0,!1),await m(500)}async function at(){theatre.toggleNarratorBar(!1,!1),await m(500)}async function ct(e){A()||await q(),M("narrator",e)}function O(){return Object.keys(Theatre.FLYIN_ANIMS)}function Zt(e){return O().includes(e)}function T(e,t){if(!Zt(e))throw new C(e);if(t==="narrator")theatre.theatreNarrator.setAttribute("textflyin",e);else if(t){let n=c(t);if(!(n instanceof Actor))throw new s;if(!g(n))throw new d;theatre.setUserEmote(game.user?.id,`theatre-${n.id}`,"textflyin",e,!1)}else theatre.setUserEmote(game.user?.id,theatre.speakingAs,"textflyin",e,!1)}function z(e){if(e==="narrator")return theatre.theatreNarrator.getAttribute("textflyin")??O()[0];if(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${t.id}`).textFlyin}else{if(A())return theatre.theatreNarrator.getAttribute("textflyin")??"";if(theatre.speakingAs)return theatre.getInsertById(theatre.speakingAs).textFlyin??"";throw new s}}var Jt="\u{1F3AD}",Qt=`${Jt} Theatre Inserts Automation`,S=K(console.log),vn=K(console.warn),xn=K(console.error),An=K(console.info);function K(e){return function(...t){(typeof t[0]=="boolean"?t[0]:!1)&&e(Qt,"|",...t)}}var G=R()[0],Y=2,Z="#ffffff";function R(){return[...Object.values(game.settings?.settings.get("theatre.nameFont")?.choices??[]),...FontConfig.getAvailableFonts()]}function B(e){return R().includes(e)}async function lt(e,t){if(!et(t))throw new w(t);return FontConfig.loadFont(e,{editor:!1,fonts:[{urls:[t]}]})}function ut(e){if(e==="narrator")return{name:theatre.theatreNarrator.getAttribute("textfont")||G,color:theatre.theatreNarrator.getAttribute("textcolor")||Z,size:parseInt(theatre.theatreNarrator.getAttribute("textsize")??"")||Y};if(e){let t=c(e);if(!(t instanceof Actor))throw new s;let n=theatre.getInsertById(`theatre-${t.id}`);if(!n)throw new d;return{name:n.textFont||G,color:n.textColor||Z,size:parseInt(n.textSize)||Y}}else{let t=null,n=p(),r=h();if(n instanceof Actor?t=n:r.length===1&&r[0]instanceof Actor&&(t=r[0]),!(t instanceof Actor))throw new s;let o=theatre.getInsertById(`theatre-${t.id}`);if(!o)throw new d;return{name:o.textFont||G,color:o.textColor||Z,size:parseInt(o.textSize)||Y}}}function ft(e,t){if(e.name&&!B(e.name))throw new w(e.name);if(e.size&&!(e.size>0&&e.size<4))throw new E(e.size);if(e.color&&!V(e.color))throw new b(e.color);if(t==="narrator")e.name&&theatre.theatreNarrator.setAttribute("textfont",e.name),e.size&&theatre.theatreNarrator.setAttribute("textsize",e.size.toString()),e.color&&theatre.theatreNarrator.setAttribute("textcolor",e.color);else if(t){let n=c(t);if(!(n instanceof Actor))throw new s;let r=theatre.getInsertById(`theatre-${n.id}`);if(!r)throw new d;e.name&&(r.textFont=e.name),e.color&&(r.textColor=e.color),e.size&&(r.textSize=e.size)}else{let n=null,r=p(),o=h();if(r instanceof Actor?n=r:o.length===1&&o[0]instanceof Actor&&(n=o[0]),!(n instanceof Actor))throw new s;let i=theatre.getInsertById(`theatre-${n.id}`);if(!i)throw new d;e.name&&(i.textFont=e.name),e.color&&(i.textColor=e.color),e.size&&(i.textSize=e.size)}}function dt(e){if(e==="narrator")return theatre.theatreNarrator.getAttribute("textfont")??null;if(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${t.id}`).textFont??null}else if(p()){let t=p();if(!(t instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${t.id}`).textFont??null}else if(h().length){let t=h();if(t.length>1)throw new s;return theatre.getInsertById(`theatre-${t[0].id}`).textFont??null}else throw new s}function pt(e,t){if(!B(e))throw new w(e);if(t==="narrator")theatre.theatreNarrator.setAttribute("textfont",e);else if(t){let n=c(t);if(!(n instanceof Actor))throw new s;if(!g(n))throw new d;theatre.getInsertById(`theatre-${n.id}`).textFont=e}else if(p()){let n=p();if(!(n instanceof Actor))throw new s;theatre.getInsertById(`theatre-${n.id}`).textFont=e}else if(h()&&h().length===1)theatre.getInsertById(`theatre-${h()[0].id}`).textFont=e;else throw new s}function mt(e){if(e==="narrator"){let t=parseInt(theatre.theatreNarrator.getAttribute("textsize"));if(t>0&&t<4)return t;throw new E(t)}else if(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${t.id}`)?.textSize||1}else{let t=p(),n=h()[0],r=t||n||null;if(!(r instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${r.id}`)?.textSize||1}}function ht(e,t){if(e<1||e>3)throw new E(e);if(t==="narrator")theatre.theatreNarrator.setAttribute("textsize",e.toString());else if(t){let n=c(t);if(S("Arg:",t,n),!(n instanceof Actor))throw new s;let r=theatre.getInsertById(`theatre-${n.id}`);if(!r)throw new d;r.textSize=e}else{let n=null,r=p();r instanceof Actor&&(n=r);let o=h();if(o.length===1&&o[0]instanceof Actor&&(n=o[0]),!(n instanceof Actor))throw new s;let i=theatre.getInsertById(`theatre-${n.id}`);if(!i)throw new d;i.textSize=e}}function gt(e){if(e==="narrator")return theatre.theatreNarrator.getAttribute("textcolor")??"#ffffff";if(e){let t=c(e);if(!(t instanceof Actor))throw new s;let n=theatre.getInsertById(`theatre-${t.id}`);if(!n)throw new d;return n.textColor??"#ffffff"}else{let t=null,n=p(),r=h();if(n instanceof Actor?t=n:r.length===1&&r[0]instanceof Actor&&(t=r[0]),!(t instanceof Actor))throw new s;let o=theatre.getInsertById(`theatre-${t.id}`);if(!o)throw new d;return o.textColor??"#ffffff"}}function vt(e,t){if(!V(e))throw new b(e);if(t==="narrator")theatre.theatreNarrator.setAttribute("textcolor",e);else if(t){let n=c(t);if(!(n instanceof Actor))throw new s;let r=theatre.getInsertById(`theatre-${n.id}`);if(!r)throw new d;r.textColor=e}else{let n=null,r=p(),o=h();if(r instanceof Actor?n=r:o.length===1&&o[0]instanceof Actor&&(n=o[0]),!(n instanceof Actor))throw new s;let i=theatre.getInsertById(`theatre-${n.id}`);if(!i)throw new d;i.textColor=e}}var Mt=qt(Tt());var k=class{constructor(t,n={}){let r={placeholder:"Select an option",columns:1,name:"",width:"",height:"",data:[],onChange:function(){}};this.options=Object.assign(r,n),this.selectElement=typeof t=="string"?document.querySelector(t):t;for(let o in this.selectElement.dataset)this.options[o]!==void 0&&(this.options[o]=this.selectElement.dataset[o]);if(this.name=this.selectElement.getAttribute("name")?this.selectElement.getAttribute("name"):"dynamic-select-"+Math.floor(Math.random()*1e6),!this.options.data.length){let o=this.selectElement.querySelectorAll("option");for(let i=0;i<o.length;i++)this.options.data.push({value:o[i].value,text:o[i].innerHTML,img:o[i].getAttribute("data-img"),selected:o[i].selected,html:o[i].getAttribute("data-html"),imgWidth:o[i].getAttribute("data-img-width"),imgHeight:o[i].getAttribute("data-img-height")})}this.element=this._template(),this.selectElement.replaceWith(this.element),this._updateSelected(),this._eventHandlers()}_template(){let t="";for(let o=0;o<this.data.length;o++){let i=100/this.columns,a="";this.data[o].html?a=this.data[o].html:a=`
                    ${this.data[o].img?`<img src="${this.data[o].img}" alt="${this.data[o].text}" class="${this.data[o].imgWidth&&this.data[o].imgHeight?"dynamic-size":""}" style="${this.data[o].imgWidth?"width:"+this.data[o].imgWidth+";":""}${this.data[o].imgHeight?"height:"+this.data[o].imgHeight+";":""}">`:""}
                    ${this.data[o].text?'<span class="dynamic-select-option-text">'+this.data[o].text+"</span>":""}
                `,t+=`
                <div class="dynamic-select-option${this.data[o].value==this.selectedValue?" dynamic-select-selected":""}${this.data[o].text||this.data[o].html?"":" dynamic-select-no-text"}" data-value="${this.data[o].value}" style="width:${i}%;${this.height?"height:"+this.height+";":""}">
                    ${a}
                </div>
            `}let n=`
            <div class="dynamic-select ${this.name}"${this.selectElement.id?' id="'+this.selectElement.id+'"':""} style="${this.width?"width:"+this.width+";":""}${this.height?"height:"+this.height+";":""}">
                <input type="hidden" name="${this.name}" value="${this.selectedValue}">
                <div class="dynamic-select-header" style="${this.width?"width:"+this.width+";":""}${this.height?"height:"+this.height+";":""}"><span class="dynamic-select-header-placeholder">${this.placeholder}</span></div>
                <div class="dynamic-select-options" style="${this.options.dropdownWidth?"width:"+this.options.dropdownWidth+";":""}${this.options.dropdownHeight?"height:"+this.options.dropdownHeight+";":""}">${t}</div>
            </div>
        `,r=document.createElement("div");return r.innerHTML=n,r}_eventHandlers(){this.element.querySelectorAll(".dynamic-select-option").forEach(t=>{t.onclick=()=>{this.element.querySelectorAll(".dynamic-select-selected").forEach(n=>n.classList.remove("dynamic-select-selected")),t.classList.add("dynamic-select-selected"),this.element.querySelector(".dynamic-select-header").innerHTML=t.innerHTML,this.element.querySelector("input").value=t.getAttribute("data-value"),this.data.forEach(n=>n.selected=!1),this.data.filter(n=>n.value==t.getAttribute("data-value"))[0].selected=!0,this.element.querySelector(".dynamic-select-header").classList.remove("dynamic-select-header-active"),this.options.onChange(t.getAttribute("data-value"),t.querySelector(".dynamic-select-option-text")?t.querySelector(".dynamic-select-option-text").innerHTML:"",t)}}),this.element.querySelector(".dynamic-select-header").onclick=()=>{this.element.querySelector(".dynamic-select-header").classList.toggle("dynamic-select-header-active")},this.selectElement.id&&document.querySelector('label[for="'+this.selectElement.id+'"]')&&(document.querySelector('label[for="'+this.selectElement.id+'"]').onclick=()=>{this.element.querySelector(".dynamic-select-header").classList.toggle("dynamic-select-header-active")}),document.addEventListener("click",t=>{!t.target.closest("."+this.name)&&!t.target.closest('label[for="'+this.selectElement.id+'"]')&&this.element.querySelector(".dynamic-select-header").classList.remove("dynamic-select-header-active")})}_updateSelected(){this.selectedValue&&(this.element.querySelector(".dynamic-select-header").innerHTML=this.element.querySelector(".dynamic-select-selected").innerHTML)}get selectedValue(){let t=this.data.filter(n=>n.selected);return t=t.length?t[0].value:"",t}set data(t){this.options.data=t}get data(){return this.options.data}set selectElement(t){this.options.selectElement=t}get selectElement(){return this.options.selectElement}set element(t){this.options.element=t}get element(){return this.options.element}set placeholder(t){this.options.placeholder=t}get placeholder(){return this.options.placeholder}set columns(t){this.options.columns=t}get columns(){return this.options.columns}set name(t){this.options.name=t}get name(){return this.options.name}set width(t){this.options.width=t}get width(){return this.options.width}set height(t){this.options.height=t}get height(){return this.options.height}};document.querySelectorAll("[data-dynamic-select]").forEach(e=>new k(e));function kt(e){let t=e;return{id:t.id,name:t.name,img:t.img,selected:!1}}function Nt(e){return{id:e.id??"",name:e.name,sounds:e.sounds.map(t=>ie(t))}}function ie(e){return{id:e.id??"",name:e.name,duration:e.sound?.duration||0,selected:!1}}var U=class extends FormApplication{constructor(n,r){let o=foundry.utils.mergeObject({musicWait:0,portraitWait:0,closeWait:0,selectedActor:null,selectedSound:null},n);super(o,r);this.events=new Mt.default;S("Options:",this.options)}_updateObject(n,r){if(S("updateObject:",r),r){let o=r.actorSelect?c(r.actorSelect):null;if(!(o instanceof Actor))throw new s;let i,a;if(r.soundSelect){let[u,y]=r.soundSelect.split("-");i=N(u),i instanceof Playlist&&(a=W(y,i))}this.object={selectedActor:o,selectedSound:a,musicWait:r.musicWait??0,portraitWait:r.portraitWait??0,introMessage:r.introMessage??"",closeWait:r.closeWait??0}}return Promise.resolve()}_render(n,r){return super._render(n,r).then(()=>{this.emit("render")})}async close(n){await super.close(n),n?.submit?this.emit("submit",this.object):this.emit("cancel"),this.emit("close")}getData(n){let r=game.playlists.contents.map(u=>Nt(u)),i={actors:game.actors.contents.map(u=>({...kt(u),...this.object?.selectedActor?.id===u.id?{selected:!0}:{selected:!1}})),playlists:r,introMessage:this.object.introMessage},a=super.getData(n);return typeof a.then=="function"?a.then(u=>foundry.utils.mergeObject(u,i)):foundry.utils.mergeObject(a,i)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:game.i18n?.localize("THEATREAUTOMATION.DIALOGS.INTRO.TITLE")||"",template:"/modules/theatre-inserts-automation/templates/intro/application.hbs",closeOnSubmit:!0,submitOnClose:!1,submitOnChange:!1})}activateListeners(n){super.activateListeners(n),new k("#actorSelect",{name:"actorSelect",onChange:(r,o,i)=>{S("Dynamic select:",r,o,i)}}),n.find("input[type='number']").on("focus",function(){$(this).trigger("select")}),n.find("[data-action='submit']").on("click",r=>{this.close({submit:!0}),r.preventDefault()}),n.find("[data-action='cancel']").on("click",r=>{this.close({submit:!1}),r.preventDefault()})}addListener(n,r){return this.events.addListener(n,r),this}on(n,r){return this.events.on(n,r),this}once(n,r){return this.events.once(n,r),this}removeListener(n,r){return this.events.removeListener(n,r),this}off(n,r){return this.events.off(n,r),this}removeAllListeners(n){return this.events.removeAllListeners(n),this}setMaxListeners(n){return this.events.setMaxListeners(n),this}getMaxListeners(){return this.events.getMaxListeners()}listeners(n){return this.events.listeners(n)}rawListeners(n){return this.events.rawListeners(n)}emit(n,...r){return this.events.emit(n,...r)}listenerCount(n,r){return this.events.listenerCount(n,r)}prependListener(n,r){return this.events.prependListener(n,r),this}prependOnceListener(n,r){return this.events.prependOnceListener(n,r),this}eventNames(){return this.events.eventNames()}};function H(e,t,n="typewriter"){let r=c(e);if(!(r instanceof Actor))throw new s;return v(r)||F(r),(g(r)?Promise.resolve():x(r)).then(()=>{ae(r)||se(r);let o=z();T(n),M(r.name,t),T(o)})}function se(e){if(!v(e))throw new P;if(!g)throw new d;let t=theatre.getNavItemById(`theatre-${e.id}`);t.classList.contains("theatre-control-nav-bar-item-speakingas")||theatre.handleNavItemMouseUp({currentTarget:t,button:0})}function ae(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.getNavItemById(`theatre-${t.id}`).classList.contains("theatre-control-nav-bar-item-speakingas")}function Pt(e){e?.parent?.playSound(e)}async function Ct(e){return new Promise((t,n)=>{let r=c(e);e!==void 0&&!(r instanceof Actor)&&n(new s),new U({...r?{selectedActor:r}:{}}).once("submit",t).once("cancel",()=>{t(void 0)}).render(!0)})}async function _t(e,t,n=0,r=0,o,i=0){let a=c(e);if(!(a instanceof Actor))throw new s;let u=[];o instanceof PlaylistSound&&u.push(m(r).then(()=>Pt(o))),u.push(m(n).then(()=>t?H(a,t).then(()=>{if(i)return m(i).then(()=>{L(a)})}):x(a).then(()=>{if(i)return m(i).then(()=>{L(a)})}))),await Promise.all(u)}function Ot(e){if(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.mirrorInsertById(`theatre-${t.id}`,!1),m(500)}else{let t=p(),n=h(),r=null;if(t instanceof Actor?r=t:n.length===1&&n[0]instanceof Actor&&(r=n[0]),!(r instanceof Actor))throw new s;return theatre.mirrorInsertById(`theatre-${r.id}`),m(500)}}function Q(){return["none",...Object.keys(Theatre.STANDING_ANIMS)]}function ce(e){return Q().includes(e)}function zt(e,t){if(!ce(e))throw new _(e);if(t==="narrator")theatre.theatreNarrator.setAttribute("textstanding",e);else if(t){let n=c(t);if(!(n instanceof Actor))throw new s;if(!g(n))throw new d;theatre.setUserEmote(game.user?.id,`theatre-${n.id}`,"textstanding",e,!1)}else if(theatre.speakingAs)theatre.setUserEmote(game.user?.id,theatre.speakingAs,"textstanding",e,!1);else if(A())theatre.theatreNarrator.setAttribute("textstanding",e);else throw new s}function Kt(e){if(e==="narrator")return theatre.theatreNarrator.getAttribute("textstanding");if(e){let t=c(e);if(!(t instanceof Actor))throw new s;return theatre.getInsertById(`theatre-${t.id}`).textStanding}else{if(A())return theatre.theatreNarrator.getAttribute("textstanding");{let t=p();if(t instanceof Actor)return theatre.getInsertById(`theatre-${t.id}`).textStanding;throw new s}}}var $t={wait:m,activateActor:x,deactivateActor:L,isActorActive:g,isActorStaged:v,stageActor:F,unstageActor:nt,sendMessage:H,setEmote:ot,clearEmote:it,getActorIntroData:Ct,introduceActor:_t,isNarratorBarActive:A,activateNarratorBar:q,deactivateNarratorBar:at,sendNarration:ct,setTextFlyin:T,getTextFlyin:z,getTextStanding:Kt,setTextStanding:zt,currentlySpeaking:p,currentlyActive:h,isValidFont:B,getFontName:dt,setFontName:pt,getFontSize:mt,setFontSize:ht,getFontColor:gt,setFontColor:vt,getFont:ut,setFont:ft,loadFont:lt,mirrorInsert:Ot};Hooks.once("ready",async()=>{game instanceof Game&&!game.modules.get("theatre")?.active?ui.notifications?.error(game.i18n?.format("THEATREAUTOMATION.ERRORS.THEATREINSERTSNOTFOUND",{MODULENAME:"Theatre Inserts Automation"})):(window.TheatreAutomation=$t,await loadTemplates(["/modules/theatre-inserts-automation/templates/intro/application.hbs"]),window.TheatreAutomation.STANDING_NAMES=Q(),window.TheatreAutomation.FLYIN_NAMES=O(),window.TheatreAutomation.FONT_NAMES=R())});
