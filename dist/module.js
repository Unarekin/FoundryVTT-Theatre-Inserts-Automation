var ee=Object.create;var S=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var re=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var se=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ne(e))!ie.call(t,i)&&i!==n&&S(t,i,{get:()=>e[i],enumerable:!(o=te(e,i))||o.enumerable});return t};var ae=(t,e,n)=>(n=t!=null?ee(oe(t)):{},se(e||!t||!t.__esModule?S(n,"default",{value:t,enumerable:!0}):n,t));var q=re((Ke,I)=>{"use strict";var h=typeof Reflect=="object"?Reflect:null,k=h&&typeof h.apply=="function"?h.apply:function(e,n,o){return Function.prototype.apply.call(e,n,o)},x;h&&typeof h.ownKeys=="function"?x=h.ownKeys:Object.getOwnPropertySymbols?x=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:x=function(e){return Object.getOwnPropertyNames(e)};function de(t){console&&console.warn&&console.warn(t)}var _=Number.isNaN||function(e){return e!==e};function a(){a.init.call(this)}I.exports=a;I.exports.once=he;a.EventEmitter=a;a.prototype._events=void 0;a.prototype._eventsCount=0;a.prototype._maxListeners=void 0;var K=10;function L(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return K},set:function(t){if(typeof t!="number"||t<0||_(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");K=t}});a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};a.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||_(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function N(t){return t._maxListeners===void 0?a.defaultMaxListeners:t._maxListeners}a.prototype.getMaxListeners=function(){return N(this)};a.prototype.emit=function(e){for(var n=[],o=1;o<arguments.length;o++)n.push(arguments[o]);var i=e==="error",r=this._events;if(r!==void 0)i=i&&r.error===void 0;else if(!i)return!1;if(i){var s;if(n.length>0&&(s=n[0]),s instanceof Error)throw s;var c=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw c.context=s,c}var f=r[e];if(f===void 0)return!1;if(typeof f=="function")k(f,this,n);else for(var R=f.length,Z=j(f,R),o=0;o<R;++o)k(Z[o],this,n);return!0};function C(t,e,n,o){var i,r,s;if(L(n),r=t._events,r===void 0?(r=t._events=Object.create(null),t._eventsCount=0):(r.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),r=t._events),s=r[e]),s===void 0)s=r[e]=n,++t._eventsCount;else if(typeof s=="function"?s=r[e]=o?[n,s]:[s,n]:o?s.unshift(n):s.push(n),i=N(t),i>0&&s.length>i&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=t,c.type=e,c.count=s.length,de(c)}return t}a.prototype.addListener=function(e,n){return C(this,e,n,!1)};a.prototype.on=a.prototype.addListener;a.prototype.prependListener=function(e,n){return C(this,e,n,!0)};function fe(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function H(t,e,n){var o={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},i=fe.bind(o);return i.listener=n,o.wrapFn=i,i}a.prototype.once=function(e,n){return L(n),this.on(e,H(this,e,n)),this};a.prototype.prependOnceListener=function(e,n){return L(n),this.prependListener(e,H(this,e,n)),this};a.prototype.removeListener=function(e,n){var o,i,r,s,c;if(L(n),i=this._events,i===void 0)return this;if(o=i[e],o===void 0)return this;if(o===n||o.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,o.listener||n));else if(typeof o!="function"){for(r=-1,s=o.length-1;s>=0;s--)if(o[s]===n||o[s].listener===n){c=o[s].listener,r=s;break}if(r<0)return this;r===0?o.shift():me(o,r),o.length===1&&(i[e]=o[0]),i.removeListener!==void 0&&this.emit("removeListener",e,c||n)}return this};a.prototype.off=a.prototype.removeListener;a.prototype.removeAllListeners=function(e){var n,o,i;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[e]),this;if(arguments.length===0){var r=Object.keys(o),s;for(i=0;i<r.length;++i)s=r[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=o[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(i=n.length-1;i>=0;i--)this.removeListener(e,n[i]);return this};function D(t,e,n){var o=t._events;if(o===void 0)return[];var i=o[e];return i===void 0?[]:typeof i=="function"?n?[i.listener||i]:[i]:n?pe(i):j(i,i.length)}a.prototype.listeners=function(e){return D(this,e,!0)};a.prototype.rawListeners=function(e){return D(this,e,!1)};a.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):U.call(t,e)};a.prototype.listenerCount=U;function U(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?x(this._events):[]};function j(t,e){for(var n=new Array(e),o=0;o<e;++o)n[o]=t[o];return n}function me(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function pe(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function he(t,e){return new Promise(function(n,o){function i(s){t.removeListener(e,r),o(s)}function r(){typeof t.removeListener=="function"&&t.removeListener("error",i),n([].slice.call(arguments))}F(t,e,r,{once:!0}),e!=="error"&&ve(t,i,{once:!0})})}function ve(t,e,n){typeof t.on=="function"&&F(t,"error",e,n)}function F(t,e,n,o){if(typeof t.on=="function")o.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function i(r){o.once&&t.removeEventListener(e,i),n(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}});var ce="\u{1F3AD}",le=`${ce} Theatre Inserts Automation`,m=A(console.log),Ee=A(console.warn),we=A(console.error),xe=A(console.info);function A(t){return function(...e){(typeof e[0]=="boolean"?e[0]:!1)&&t(le,"|",...e)}}function l(t){if(t instanceof Actor)return t;if(t instanceof Token)return t.actor;if(typeof t=="string"){let e=game.actors?.get(t);if(e||(e=game.actors?.getName(t),e))return e}}function E(t){if(t instanceof Playlist)return t;if(typeof t=="string"){let e=game.playlists?.get(t);if(e||(e=game.playlists?.getName(t),e))return e}}function b(t,e){if(t instanceof PlaylistSound)return t;let n=E(e);if(n&&typeof t=="string"){let o=n.sounds.get(t);if(o instanceof PlaylistSound||(o=n.sounds.getName(t),o instanceof PlaylistSound))return o}}function P(t,e){let n=l(t);if(!(n instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));return ue(n,e)}async function ue(t,e){p(t)||await d(t),theatre.setUserEmote(game.user?.id,`theatre-${t.id}`,"emote",e,!1)}function w(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));theatre.setUserEmote(game.user?.id,`theatre-${e.id}`,"emote","",!1)}async function u(t){return new Promise(e=>{setTimeout(e,t)})}function d(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));return theatre.getNavItemById(`theatre-${e.id}`)||Theatre.addToNavBar(e),theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${e.id}`),button:2}),u(1e3)}function g(t,e){let n=l(t);if(!(n instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));return theatre.removeInsertById(`theatre-${n.id}`,!1),e&&theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${n.id}`),button:2,ctrlKey:!0}),w(n),u(1e3)}function p(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));let n=theatre.getNavItemById(`theatre-${e.id}`);return n?n.classList.contains("theatre-control-nav-bar-item-speakingas"):!1}var z=ae(q());var y=class{constructor(e,n={}){let o={placeholder:"Select an option",columns:1,name:"",width:"",height:"",data:[],onChange:function(){}};this.options=Object.assign(o,n),this.selectElement=typeof e=="string"?document.querySelector(e):e;for(let i in this.selectElement.dataset)this.options[i]!==void 0&&(this.options[i]=this.selectElement.dataset[i]);if(this.name=this.selectElement.getAttribute("name")?this.selectElement.getAttribute("name"):"dynamic-select-"+Math.floor(Math.random()*1e6),!this.options.data.length){let i=this.selectElement.querySelectorAll("option");for(let r=0;r<i.length;r++)this.options.data.push({value:i[r].value,text:i[r].innerHTML,img:i[r].getAttribute("data-img"),selected:i[r].selected,html:i[r].getAttribute("data-html"),imgWidth:i[r].getAttribute("data-img-width"),imgHeight:i[r].getAttribute("data-img-height")})}this.element=this._template(),this.selectElement.replaceWith(this.element),this._updateSelected(),this._eventHandlers()}_template(){let e="";for(let i=0;i<this.data.length;i++){let r=100/this.columns,s="";this.data[i].html?s=this.data[i].html:s=`
                    ${this.data[i].img?`<img src="${this.data[i].img}" alt="${this.data[i].text}" class="${this.data[i].imgWidth&&this.data[i].imgHeight?"dynamic-size":""}" style="${this.data[i].imgWidth?"width:"+this.data[i].imgWidth+";":""}${this.data[i].imgHeight?"height:"+this.data[i].imgHeight+";":""}">`:""}
                    ${this.data[i].text?'<span class="dynamic-select-option-text">'+this.data[i].text+"</span>":""}
                `,e+=`
                <div class="dynamic-select-option${this.data[i].value==this.selectedValue?" dynamic-select-selected":""}${this.data[i].text||this.data[i].html?"":" dynamic-select-no-text"}" data-value="${this.data[i].value}" style="width:${r}%;${this.height?"height:"+this.height+";":""}">
                    ${s}
                </div>
            `}let n=`
            <div class="dynamic-select ${this.name}"${this.selectElement.id?' id="'+this.selectElement.id+'"':""} style="${this.width?"width:"+this.width+";":""}${this.height?"height:"+this.height+";":""}">
                <input type="hidden" name="${this.name}" value="${this.selectedValue}">
                <div class="dynamic-select-header" style="${this.width?"width:"+this.width+";":""}${this.height?"height:"+this.height+";":""}"><span class="dynamic-select-header-placeholder">${this.placeholder}</span></div>
                <div class="dynamic-select-options" style="${this.options.dropdownWidth?"width:"+this.options.dropdownWidth+";":""}${this.options.dropdownHeight?"height:"+this.options.dropdownHeight+";":""}">${e}</div>
            </div>
        `,o=document.createElement("div");return o.innerHTML=n,o}_eventHandlers(){this.element.querySelectorAll(".dynamic-select-option").forEach(e=>{e.onclick=()=>{this.element.querySelectorAll(".dynamic-select-selected").forEach(n=>n.classList.remove("dynamic-select-selected")),e.classList.add("dynamic-select-selected"),this.element.querySelector(".dynamic-select-header").innerHTML=e.innerHTML,this.element.querySelector("input").value=e.getAttribute("data-value"),this.data.forEach(n=>n.selected=!1),this.data.filter(n=>n.value==e.getAttribute("data-value"))[0].selected=!0,this.element.querySelector(".dynamic-select-header").classList.remove("dynamic-select-header-active"),this.options.onChange(e.getAttribute("data-value"),e.querySelector(".dynamic-select-option-text")?e.querySelector(".dynamic-select-option-text").innerHTML:"",e)}}),this.element.querySelector(".dynamic-select-header").onclick=()=>{this.element.querySelector(".dynamic-select-header").classList.toggle("dynamic-select-header-active")},this.selectElement.id&&document.querySelector('label[for="'+this.selectElement.id+'"]')&&(document.querySelector('label[for="'+this.selectElement.id+'"]').onclick=()=>{this.element.querySelector(".dynamic-select-header").classList.toggle("dynamic-select-header-active")}),document.addEventListener("click",e=>{!e.target.closest("."+this.name)&&!e.target.closest('label[for="'+this.selectElement.id+'"]')&&this.element.querySelector(".dynamic-select-header").classList.remove("dynamic-select-header-active")})}_updateSelected(){this.selectedValue&&(this.element.querySelector(".dynamic-select-header").innerHTML=this.element.querySelector(".dynamic-select-selected").innerHTML)}get selectedValue(){let e=this.data.filter(n=>n.selected);return e=e.length?e[0].value:"",e}set data(e){this.options.data=e}get data(){return this.options.data}set selectElement(e){this.options.selectElement=e}get selectElement(){return this.options.selectElement}set element(e){this.options.element=e}get element(){return this.options.element}set placeholder(e){this.options.placeholder=e}get placeholder(){return this.options.placeholder}set columns(e){this.options.columns=e}get columns(){return this.options.columns}set name(e){this.options.name=e}get name(){return this.options.name}set width(e){this.options.width=e}get width(){return this.options.width}set height(e){this.options.height=e}get height(){return this.options.height}};document.querySelectorAll("[data-dynamic-select]").forEach(t=>new y(t));function V(t){let e=t;return{id:e.id,name:e.name,img:e.img,selected:!1}}function W(t){return{id:t.id??"",name:t.name,sounds:t.sounds.map(e=>ge(e))}}function ge(t){return{id:t.id??"",name:t.name,duration:t.sound?.duration||0,selected:!1}}var T=class extends FormApplication{constructor(n,o){let i=foundry.utils.mergeObject({musicWait:0,portraitWait:0,closeWait:0,selectedActor:null,selectedSound:null},n);super(i,o);this.events=new z.default;m("Options:",this.options)}_updateObject(n,o){if(m("updateObject:",o),o){let i=o.actorSelect?l(o.actorSelect):null;if(!(i instanceof Actor))throw new Error("THEATREAUTOMATION.ERRORS.INVALIDACTOR");let r,s;if(o.soundSelect){let[c,f]=o.soundSelect.split("-");r=E(c),r instanceof Playlist&&(s=b(f,r))}this.object={selectedActor:i,selectedSound:s,musicWait:o.musicWait??0,portraitWait:o.portraitWait??0,introMessage:o.introMessage??"",closeWait:o.closeWait??0}}return Promise.resolve()}_render(n,o){return super._render(n,o).then(()=>{this.emit("render")})}async close(n){await super.close(n),n?.submit?this.emit("submit",this.object):this.emit("cancel"),this.emit("close")}getData(n){let o=game.playlists.contents.map(c=>W(c)),r={actors:game.actors.contents.map(c=>({...V(c),...this.object?.selectedActor?.id===c.id?{selected:!0}:{selected:!1}})),playlists:o,introMessage:this.object.introMessage},s=super.getData(n);return typeof s.then=="function"?s.then(c=>foundry.utils.mergeObject(c,r)):foundry.utils.mergeObject(s,r)}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{title:game.i18n?.localize("THEATREAUTOMATION.DIALOGS.INTRO.TITLE")||"",template:"/modules/theatre-inserts-automation/templates/intro/application.hbs",closeOnSubmit:!0,submitOnClose:!1,submitOnChange:!1})}activateListeners(n){super.activateListeners(n),new y("#actorSelect",{name:"actorSelect",onChange:(o,i,r)=>{m("Dynamic select:",o,i,r)}}),n.find("input[type='number']").on("focus",function(){$(this).trigger("select")}),n.find("[data-action='submit']").on("click",o=>{this.close({submit:!0}),o.preventDefault()}),n.find("[data-action='cancel']").on("click",o=>{this.close({submit:!1}),o.preventDefault()})}addListener(n,o){return this.events.addListener(n,o),this}on(n,o){return this.events.on(n,o),this}once(n,o){return this.events.once(n,o),this}removeListener(n,o){return this.events.removeListener(n,o),this}off(n,o){return this.events.off(n,o),this}removeAllListeners(n){return this.events.removeAllListeners(n),this}setMaxListeners(n){return this.events.setMaxListeners(n),this}getMaxListeners(){return this.events.getMaxListeners()}listeners(n){return this.events.listeners(n)}rawListeners(n){return this.events.rawListeners(n)}emit(n,...o){return this.events.emit(n,...o)}listenerCount(n,o){return this.events.listenerCount(n,o)}prependListener(n,o){return this.events.prependListener(n,o),this}prependOnceListener(n,o){return this.events.prependOnceListener(n,o),this}eventNames(){return this.events.eventNames()}};function v(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));return!!theatre.getNavItemById(`theatre-${e.id}`)}function O(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));v(e)||Theatre.addToNavBar(e)}function B(t){let e=l(t);if(!(e instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));v(e)&&theatre.handleNavItemMouseUp({currentTarget:theatre.getNavItemById(`theatre-${e.id}`),button:2,ctrlKey:!0})}function M(t,e){let n=l(t);if(!(n instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));return ye(n,e)}async function ye(t,e){v(t)||O(t),p(t)||await d(t);let n=theatre.getNavItemById(`theatre-${t.id}`);n.classList.contains("theatre-control-nav-bar-item-speakingas")||theatre.handleNavItemMouseUp({currentTarget:n,button:0});let o=$("#chat-message"),i=o.val()??"",r=o.is(":selected");theatre.setUserTyping(game.user?.id,theatre.speakingAs),o.val(e),o.trigger("focus"),o.trigger(G("keydown")),o.trigger(G("keyup")),o.val(i),r||o.trigger("blur")}function G(t){return jQuery.Event(t,{which:13,keyCode:13,originalEvent:new KeyboardEvent(t,{code:"Enter",key:"Enter",charCode:13,keyCode:13,view:window,bubbles:!0})})}function Q(t){t?.parent?.playSound(t)}async function J(t){return new Promise((e,n)=>{let o=l(t);t!==void 0&&!(o instanceof Actor)&&n(new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"))),new T({...o?{selectedActor:o}:{}}).once("submit",e).once("cancel",()=>{e(void 0)}).render(!0)})}async function X(t,e,n=0,o=0,i,r=0){let s=l(t);if(!(s instanceof Actor))throw new Error(game.i18n?.localize("THEATREAUTOMATION.ERRORS.INVALIDACTOR"));let c=[];i instanceof PlaylistSound&&c.push(u(o).then(()=>Q(i))),c.push(u(n).then(()=>e?M(s,e).then(()=>{if(r)return u(r).then(()=>{g(s)})}):d(s).then(()=>{if(r)return u(r).then(()=>{g(s)})}))),await Promise.all(c)}var Y={wait:u,activateActor:d,deactivateActor:g,isActorActive:p,isActorStaged:v,stageActor:O,unstageActor:B,sendMessage:M,setEmote:P,clearEmote:w,getActorIntroData:J,introduceActor:X};Hooks.once("init",async()=>{window.TheatreAutomation=Y,await loadTemplates(["/modules/theatre-inserts-automation/templates/intro/application.hbs"]),m("Initialized")});Hooks.once("ready",()=>{game instanceof Game&&!game.modules.get("theatre")?.active&&ui.notifications?.error(game.i18n?.format("THEATREAUTOMATION.ERRORS.THEATREINSERTSNOTFOUND",{MODULENAME:"Theatre Inserts Automation"}))});
